<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mensagens Recebidas - Admin | World Inova</title>
    <link rel="stylesheet" href="css/style.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js"></script>
</head>
<body>
    <header class="header-dark">
        <div style="display:flex;align-items:center;justify-content:space-between;max-width:700px;margin:32px auto 24px auto;">
            <button id="btn-voltar" class="btn-dark small" style="margin-right:16px;">&larr; Voltar</button>
            <h2 style="text-align:center;flex:1;">Mensagens Recebidas</h2>
            <button id="logout-admin" class="btn-dark small" style="margin-left:16px;display:none;">Sair</button>
        </div>
    </header>
    <main>
        <div id="mensagens-list" style="max-width:700px;margin:0 auto;"></div>
    </main>
    <footer class="footer-dark" style="margin-top:40px;">
        <p>&copy; 2025 World Inova. Todos os direitos reservados.</p>
    </footer>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAbsVCpF09twr4wpCYHB_cbA1oNkCuqtj0",
            authDomain: "site-mundoteknologia.firebaseapp.com",
            projectId: "site-mundoteknologia",
            storageBucket: "site-mundoteknologia.appspot.com",
            messagingSenderId: "171461943616",
            appId: "1:171461943616:web:07cb0ada17038be0641aa5",
            measurementId: "G-EJTL4ERWMP",
            databaseURL: "https://site-mundoteknologia-default-rtdb.firebaseio.com"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        const ADMINS = [
            "Frty58XjXdfYNxh0gquwjgBMEv12",
            "q8CyMhIWREMI6QrZVlUQvFeMQTC2",
            "rPn9EWLFGWRnPbxAm3BTrplK3Wh1"
        ];

        function formatDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            return date.toLocaleString('pt-BR', {
                day: '2-digit', month: '2-digit', year: 'numeric',
                hour: '2-digit', minute: '2-digit'
            });
        }

        function groupByDay(messages) {
            const grouped = {};
            messages.forEach(msg => {
                const date = new Date(msg.data);
                const day = date.toLocaleDateString('pt-BR');
                if (!grouped[day]) grouped[day] = [];
                grouped[day].push(msg);
            });
            return grouped;
        }

        function carregarMensagens() {
            const lista = document.getElementById('mensagens-list');
            lista.innerHTML = "<p>Carregando...</p>";
            onValue(ref(db, 'mensagens'), (snapshot) => {
                let messages = [];
                snapshot.forEach(function(child) {
                    const msg = child.val();
                    if (msg.data) {
                        msg._dataObj = new Date(msg.data);
                    } else {
                        msg._dataObj = new Date(0);
                    }
                    messages.push(msg);
                });
                // Ordena por data decrescente
                messages.sort((a, b) => b._dataObj - a._dataObj);

                // Agrupa por dia
                const grouped = groupByDay(messages);

                let html = "";
                Object.keys(grouped).sort((a, b) => {
                    // Ordena os dias do mais recente para o mais antigo
                    const [d1, m1, y1] = a.split('/').map(Number);
                    const [d2, m2, y2] = b.split('/').map(Number);
                    return new Date(y2, m2 - 1, d2) - new Date(y1, m1 - 1, d1);
                }).forEach(day => {
                    html += `<h3 style="margin-top:24px;color:#e9d460;">${day}</h3>`;
                    grouped[day].forEach(msg => {
                        html += `<div style="border:1px solid #333;padding:12px 16px;margin-bottom:12px;background:#23272f;color:#fff;border-radius:8px;box-shadow:0 2px 8px #0002;">
                            <div style="font-size:0.95em;margin-bottom:4px;"><b>Nome:</b> ${msg.nome || ''}</div>
                            <div style="font-size:0.95em;margin-bottom:4px;"><b>Email:</b> ${msg.email || ''}</div>
                            <div style="font-size:1.05em;margin-bottom:6px;"><b>Mensagem:</b> ${msg.mensagem || ''}</div>
                            <div style="font-size:0.85em;color:#bdbdbd;text-align:right;"><small>${formatDate(msg.data)}</small></div>
                        </div>`;
                    });
                });

                lista.innerHTML = html || "<p>Nenhuma mensagem recebida.</p>";
            });
        }

        onAuthStateChanged(auth, (user) => {
            if (user && ADMINS.includes(user.uid)) {
                document.getElementById('logout-admin').style.display = 'inline-block';
                carregarMensagens();
            } else {
                window.location.href = "index.html#admin";
            }
        });

        document.getElementById('logout-admin').addEventListener('click', function() {
            signOut(auth).then(() => {
                window.location.href = "index.html";
            });
        });

        document.getElementById('btn-voltar').addEventListener('click', function() {
            window.location.href = "index.html";
        });
    </script>
</body>
</html>