<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mensagens Recebidas - Admin | World Inova</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        body {
            background: radial-gradient(ellipse at top left, #23272f 60%, #1a1a2e 100%);
            min-height: 100vh;
            font-family: 'Inter', 'Poppins', Arial, sans-serif;
            color: #f5f5f5;
        }
        .admin-header-bar {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            max-width: 700px;
            margin: 32px auto 0 auto;
            padding: 0 8px;
        }
        .admin-title {
            text-align: center;
            margin: 28px 0 0 0;
            font-size: 2.1rem;
            font-weight: 700;
            letter-spacing: 1px;
            color: #fff;
            text-shadow: 0 2px 12px #0008;
        }
        #mensagens-list {
            max-width: 700px;
            margin: 32px auto 0 auto;
        }
        .msg-day-title {
            margin-top: 32px;
            margin-bottom: 12px;
            color: #ffe066;
            font-size: 1.25rem;
            font-weight: 700;
            letter-spacing: 1px;
            border-left: 4px solid #e9d460;
            padding-left: 12px;
            text-shadow: 0 2px 8px #0005;
        }
        .msg-card {
            border: none;
            background: linear-gradient(120deg, #23272f 80%, #2d3250 100%);
            color: #fff;
            border-radius: 14px;
            box-shadow: 0 4px 24px #0004, 0 1.5px 0 #e9d460 inset;
            padding: 20px 24px 16px 24px;
            margin-bottom: 18px;
            transition: box-shadow 0.2s, transform 0.2s;
            position: relative;
        }
        .msg-card:hover {
            box-shadow: 0 8px 32px #0007, 0 1.5px 0 #ffe066 inset;
            transform: translateY(-2px) scale(1.01);
        }
        .msg-info {
            font-size: 1.05em;
            margin-bottom: 6px;
        }
        .msg-info b {
            color: #e9d460;
            font-weight: 600;
        }
        .msg-date {
            font-size: 0.92em;
            color: #bdbdbd;
            text-align: right;
            margin-top: 10px;
            letter-spacing: 0.5px;
        }
        .btn-dark.small {
            padding: 4px 12px;
            min-width: 70px;  
            font-size: 1em;
            border-radius: 8px;
            border: none;
            background: linear-gradient(90deg, #23272f 60%, #5f2eea 100%);
            color: #ffe066;
            font-weight: 600;
            box-shadow: 0 2px 8px #0003;
            cursor: pointer;
            transition: background 0.2s, color 0.2s, box-shadow 0.2s;
        }
        .btn-dark.small:hover {
            background: linear-gradient(90deg, #5f2eea 60%, #23272f 100%);
            color: #fff;
            box-shadow: 0 4px 16px #0005;
        }
        @media (max-width: 800px) {
            .admin-header-bar, #mensagens-list { max-width: 98vw; }
            .msg-card { padding: 14px 8px 12px 12px; }
        }
    </style>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js"></script>
</head>
<body>
    <header class="header-dark">
        <div class="admin-header-bar">
            <button id="btn-voltar" class="btn-dark small">&larr; Voltar</button>
            <button id="logout-admin" class="btn-dark small" style="display:none;">Sair</button>
        </div>
        <h2 class="admin-title">Mensagens Recebidas</h2>
    </header>
    <main>
        <div id="mensagens-list"></div>
    </main>
    <footer class="footer-dark" style="margin-top:40px;">
        <p>&copy; 2025 World Inova. Todos os direitos reservados.</p>
    </footer>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAbsVCpF09twr4wpCYHB_cbA1oNkCuqtj0",
            authDomain: "site-mundoteknologia.firebaseapp.com",
            projectId: "site-mundoteknologia",
            storageBucket: "site-mundoteknologia.appspot.com",
            messagingSenderId: "171461943616",
            appId: "1:171461943616:web:07cb0ada17038be0641aa5",
            measurementId: "G-EJTL4ERWMP",
            databaseURL: "https://site-mundoteknologia-default-rtdb.firebaseio.com"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        const ADMINS = [
            "Frty58XjXdfYNxh0gquwjgBMEv12",
            "q8CyMhIWREMI6QrZVlUQvFeMQTC2",
            "rPn9EWLFGWRnPbxAm3BTrplK3Wh1"
        ];

        function formatDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            return date.toLocaleString('pt-BR', {
                day: '2-digit', month: '2-digit', year: 'numeric',
                hour: '2-digit', minute: '2-digit'
            });
        }

        function groupByDay(messages) {
            const grouped = {};
            messages.forEach(msg => {
                const date = new Date(msg.data);
                const day = isNaN(date) ? 'Data Inválida' : date.toLocaleDateString('pt-BR');
                if (!grouped[day]) grouped[day] = [];
                grouped[day].push(msg);
            });
            return grouped;
        }

        function carregarMensagens() {
            const lista = document.getElementById('mensagens-list');
            lista.innerHTML = "<p style='text-align:center;color:#ffe066;'>Carregando...</p>";
            onValue(ref(db, 'mensagens'), (snapshot) => {
                let messages = [];
                snapshot.forEach(function(child) {
                    const msg = child.val();
                    if (msg.data) {
                        msg._dataObj = new Date(msg.data);
                    } else {
                        msg._dataObj = new Date(0);
                    }
                    messages.push(msg);
                });
                // Ordena por data decrescente
                messages.sort((a, b) => b._dataObj - a._dataObj);

                // Agrupa por dia
                const grouped = groupByDay(messages);

                let html = "";
                Object.keys(grouped).sort((a, b) => {
                    // Ordena os dias do mais recente para o mais antigo
                    if (a === 'Data Inválida') return 1;
                    if (b === 'Data Inválida') return -1;
                    const [d1, m1, y1] = a.split('/').map(Number);
                    const [d2, m2, y2] = b.split('/').map(Number);
                    return new Date(y2, m2 - 1, d2) - new Date(y1, m1 - 1, d1);
                }).forEach(day => {
                    html += `<div class="msg-day-title">${day}</div>`;
                    grouped[day].forEach(msg => {
                        html += `<div class="msg-card">
                            <div class="msg-info"><b>Nome:</b> ${msg.nome || '<span style="color:#ff5252;">(não informado)</span>'}</div>
                            <div class="msg-info"><b>Email:</b> ${msg.email || '<span style="color:#ff5252;">(não informado)</span>'}</div>
                            <div class="msg-info"><b>Mensagem:</b> ${msg.mensagem || '<span style="color:#ff5252;">(vazia)</span>'}</div>
                            <div class="msg-date">${formatDate(msg.data)}</div>
                        </div>`;
                    });
                });

                lista.innerHTML = html || "<p style='text-align:center;color:#ffe066;'>Nenhuma mensagem recebida.</p>";
            });
        }

        onAuthStateChanged(auth, (user) => {
            if (user && ADMINS.includes(user.uid)) {
                document.getElementById('logout-admin').style.display = 'inline-block';
                carregarMensagens();
            } else {
                window.location.href = "index.html#admin";
            }
        });

        document.getElementById('logout-admin').addEventListener('click', function() {
            signOut(auth).then(() => {
                window.location.href = "index.html";
            });
        });

        document.getElementById('btn-voltar').addEventListener('click', function() {
            window.location.href = "index.html";
        });
    </script>
</body>
</html>